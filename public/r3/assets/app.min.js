function Admin(){}function Events(){this.list={}}function Map(){this.terrain,this.zooming=!1,this.tileDomain="https://r3tiles-a.titanmods.xyz/"}function Markers(){this.list={},this.matchedIcons={},this.icons="undefined"!=typeof icons?icons:{},this.maxZoomLevelForIndividualPlayerLabels=7,this.eventGroups={positions_vehicles:{},positions_infantry:{}},this.currentUnits={positions_vehicles:[],positions_infantry:[]},this.unknownClasses=[]}function Modal(){}function Notifications(){this.enabled=!0,this.minWidth=800}function ObjectiveMarkers(){this.supportedList="undefined"!=typeof objectiveMarkersConfig?objectiveMarkersConfig:{},this.ready=!1,this.layer=null,this.validMarkerCount=0}function PlayBack(){this.zoomedToFirstPlayer=!1,this.sharedPresets={}}function Players(){this.masterList={},this.currentList={},this.factionGroups={},this.trackTarget=!1,this.collapseList={},this.listFadeEnabled=!0,this.listInactiveTimer=null,this.listFadeTime=3,this.updateFrequency=3,this.updateTimer=null,this.updateLock=!1,this.delayedUpdateTimer=null}function Poi(){this.ready=!1,this.poiLayers={}}function ReplayList(){this.lists={"missions-all":null,"missions-mine":null}}function Timeline(){this.scrubber=null,this.speed=configDefaults.speed,this.timeJump=1,this.timePointer=0,this.playing=!1,this.now,this.then=Date.now(),this.delta,this.timeBounds={min:0,max:0}}Admin.prototype.setupInteractionHandlers=function(){$("body").on("click",".js-admin-login",function(e){e.preventDefault();var t=$('input[name="admin-password"]').val();$.ajax({url:webPath+"/admin/login",type:"POST",dataType:"json",data:{password:t},success:function(e){return e.error?admin.loginError():void(window.location=webPath+"/admin/")},error:function(e,t,i){console.error("Error logging in - Status: "+t+" - Message: "+i),admin.loginError()}})})},Admin.prototype.loginError=function(){$(".feedback").remove(),$('input[name="admin-password"]').after('<div class="feedback feedback--error">Wrong password</div>')},Events.prototype.showNext=function(){var e=this;"undefined"!=typeof this.list[timeline.timePointer]&&_.each(e.list[timeline.timePointer],function(t){var i=t.type,a=e.parseData(t.value);a&&e.actionType(i,t,a)}),timeline.timePointer+=timeline.timeJump},Events.prototype.parseData=function(e){try{var t=JSON.parse(e);return t}catch(t){return console.error(t,e),timeline.stopTimer(!0),!1}},Events.prototype.actionType=function(e,t,i){var a=this;if("positions_vehicles"==e||"positions_infantry"==e)markers.processPositionalUpdate(t,i,e);else switch(e){case"get_in":markers.remove(i.unit),""!=i.id&&setTimeout(players.updateList.bind(players),500);break;case"get_out":""!=i.id&&setTimeout(players.updateList.bind(players),500);break;case"player_disconnected":var n=players.getInfo(i.id);"undefined"!=typeof n&&notifications.info(n.name+" disconnected"),markers.remove(i.unit);break;case"player_connected":var n=players.getInfo(i.id);"undefined"!=typeof n&&notifications.info(n.name+" connected");break;case"unit_awake":markers.remove(i.unit);break;case"unit_unconscious":a.hit("downed",i);break;case"unit_killed":a.hit("killed",i);break;case"incoming_missile":a.projectileLaunch(i);break;case"projectile":a.projectileExplode(i);break;case"markers":objectiveMarkers.add(i);break;default:console.warn("Unknown event",e)}},Events.prototype.hit=function(e,t){console.log(e,t.victim);var i=t.victim,a=t.attacker,n="undefined"!=typeof a,s=!1,o=players.getInfo(i.id);if(n&&"undefined"!=typeof markers.list[i.unit]&&"undefined"!=typeof markers.list[a.unit]){if(""!=a.id){var r=players.getInfo(a.id);"undefined"!=typeof r&&(s=!0)}var l=[markers.list[i.unit].getLatLng(),markers.list[a.unit].getLatLng()],p="#ED5C66",c=markers.convertFactionIdToFactionData(a.faction);p=c.color;var d=L.polyline(l,{color:p,weight:1,clickable:!1}).addTo(map.handler);setTimeout(function(){map.handler.removeLayer(d)},1e3)}if(console.log(markers.list[i.unit]),"undefined"!=typeof markers.list[i.unit]&&("unconscious"==e?markers.list[i.unit].unconscious=!0:(markers.list[i.unit].setOpacity(.4),markers.list[i.unit].killed=!0)),"undefined"!=typeof o){var m="";if(n)if(""!=a.weapon){var u=s?'<span class="toast-smaller">'+r.name+"</span> ("+a.weapon+")":'<span class="toast-smaller">'+a.weapon+"</span>";m="<span>"+o.name+"</span> was "+e+" by "+u}else m="<span>"+o.name+"</span> was "+e;else m="<span>"+o.name+"</span> "+e+' <span class="toast-smaller">himself!</span>';"killed"==e?notifications.error(m):notifications.warning(m)}},Events.prototype.projectileLaunch=function(e){var t=e.victim,i=e.attacker,a=map.gamePointToMapPoint(i.pos[0],i.pos[1]),n=markers.list[t.unit],s="undefined"!=typeof n&&n.getLatLng(),o=players.getInfo(t.id),r=L.circle(map.rc.unproject([a[0],a[1]]),50,{weight:1,color:"red",fillColor:"#f03",fillOpacity:.5,className:"missile-launch",clickable:!1}).addTo(map.handler);if(setTimeout(function(){map.handler.removeLayer(r)},1e3),s){var l=L.marker(map.rc.unproject([a[0],a[1]]),{icon:L.icon({iconUrl:"https://r3icons.titanmods.xyz/"+i.ammoType.toLowerCase()+".png",iconSize:[30,30],iconAnchor:[15,15],className:"projectile-"+i.ammoType.toLowerCase()}),clickable:!1}).addTo(map.handler);setTimeout(function(){l.setLatLng(s)},50),setTimeout(function(){map.handler.removeLayer(l)},1e3)}"undefined"!=typeof o&&notifications.info(i.ammoType+" Launch at "+o.name)},Events.prototype.projectileExplode=function(e){var t=e.unit,i=e.type,a=e.ammo.toLowerCase(),n=map.gamePointToMapPoint(e.position[0],e.position[1]),s=markers.list[t];"undefined"!=typeof s&&s.getLatLng(),players.getInfo(e.id);if("grenade"==i){var o=L.circle(map.rc.unproject([n[0],n[1]]),15,{weight:1,color:"black",opacity:.6,fill:!0,className:"projectile-grenade",clickable:!1}).addTo(map.handler);setTimeout(function(){map.handler.removeLayer(o)},1e3)}else{var r="#CCC";a.indexOf("purple")>-1&&(r="purple"),a.indexOf("green")>-1&&(r="green"),a.indexOf("red")>-1&&(r="red"),a.indexOf("blue")>-1&&(r="blue"),console.log(a,r);var l=L.circle(map.rc.unproject([n[0],n[1]]),50,{weight:40,color:r,opacity:.5,className:"projectile-smoke",clickable:!1}).addTo(map.handler);setTimeout(function(){map.handler.removeLayer(l)},5e3)}},Map.prototype.init=function(e,t){this.terrain=e.toLowerCase(),"undefined"!=typeof mappingConfig[this.terrain]&&(this.terrain=mappingConfig[this.terrain]),this.config={bgColor:"#C7E6FC",doubleSize:0,width:32768,height:32768,initZoom:4,minZoom:3,maxZoom:7},this.render(t)},Map.prototype.render=function(e){this.handler=new L.Map("map",{minZoom:this.config.minZoom,maxNativeZoom:this.config.maxZoom,maxZoom:10,zoom:this.config.initZoom,attributionControl:!1,zoomControl:!1,zoomAnimation:!0,fadeAnimation:!0}),console.log(this.config.maxZoom+4),this.currentZoomLevel=this.config.initZoom,$("#map").css("background-color",this.config.bgColor),this.rc=new L.RasterCoords(this.handler,[this.config.width,this.config.height]);var t=this.rc.unproject([0,this.config.height]),i=this.rc.unproject([this.config.width,0]);this.mapBounds=new L.LatLngBounds(t,i);var a=this.mapBounds.pad(1);this.handler.setMaxBounds(a),this.setView([this.config.height/2,this.config.width/2],this.config.initZoom);this.layer=L.tileLayer("http://db.alivemod.com/maps/"+this.terrain+"/{z}/{x}/{y}.png",{noWrap:!0,maxNativeZoom:this.config.maxZoom,maxZoom:10,errorTileUrl:webPath+"/assets/images/map/error-tile.png",tms:!0}).addTo(this.handler),this.setupInteractionHandlers(),poi.init(this.terrain),objectiveMarkers.init(),e(!1)},Map.prototype.setupInteractionHandlers=function(){var e=this;this.handler.on("zoomend",function(t){e.currentZoomLevel=t.target._zoom,console.log("Zoom changed",e.currentZoomLevel)}),this.handler.on("dragstart",function(e){players.stopTracking()}),this.handler.on("dragend",function(t){var i=e.rc.project(e.handler.getCenter()),a=e.handler.getZoom();console.log(i,a)}),this.handler.on("zoomstart",function(){e.zooming=!0}),this.handler.on("zoomend",function(){e.zooming=!1})},Map.prototype.setView=function(e,t){this.handler.setView(this.rc.unproject(e),t)},Map.prototype.gamePointToMapPoint=function(e,t){if("1"==this.config.doubleSize)var i=2*e,a=Math.abs(2*(t-this.config.height/2));else var n=this.config.height/opSize,i=e*n,a=this.config.height-t*n;return[i,a]},Map.prototype.mapPointToGamePoint=function(e,t,i){if(i=i||!1,"object"==typeof e&&(t=e.y,e=e.x),"1"==this.config.doubleSize)var a=e/2,n=Math.abs((t-this.config.height)/2);else var a=e,n=Math.abs(parseFloat(t)+parseFloat(this.config.height));return i?map.gameToGrid(a,n):[a,n]},Map.prototype.gameToGrid=function(e,t){var i=Math.round(100*e/100)/100,a=Math.round(100*t/100)/100;return[i,a]},Markers.prototype.setupLayers=function(){this.eventGroups.positions_vehicles=new L.LayerGroup([],{makeBoundsAware:!1}),this.eventGroups.positions_infantry=new L.LayerGroup([],{makeBoundsAware:!1}),this.eventGroups.positions_vehicles.addTo(map.handler),this.eventGroups.positions_infantry.addTo(map.handler)},Markers.prototype.processPositionalUpdate=function(e,t,i){var a=this,n={positions_vehicles:[],positions_infantry:[]};_.each(t,function(t){a.add(t.unit,t,i,e.missionTime),a.currentUnits[i].indexOf(t.unit)<0&&a.currentUnits[i].push(t.unit),n[i].push(t.unit)});var s=_.difference(a.currentUnits[i],n[i]);_.each(s,function(t){if("undefined"!=typeof a.list[t]){var i=e.missionTime-a.list[t].timeUpdated;i>100&&a.remove(t)}})},Markers.prototype.remove=function(e){if("undefined"!=typeof this.list[e]){this.eventGroups.positions_infantry.removeLayer(this.list[e]._leaflet_id),this.eventGroups.positions_vehicles.removeLayer(this.list[e]._leaflet_id);var t=this.currentUnits.positions_infantry.indexOf(e),i=this.currentUnits.positions_vehicles.indexOf(e);t>-1&&this.currentUnits.positions_infantry.splice(t,1),i>-1&&this.currentUnits.positions_vehicles.splice(i,1),delete this.list[e]}},Markers.prototype.add=function(e,t,i,a){var n=this,s=t.ico;if("iconLogic"!=s&&"iconVirtual"!=s){var o="positions_infantry"==i,r="positions_vehicles"==i,l=t.cls,p=t.icp,c=t.grp,d=t.crw,m=t.cgo,u=t.dir,h="undefined"!=typeof t.ldr&&"true"===t.ldr.toLowerCase(),f=map.gamePointToMapPoint(t.pos[0],t.pos[1]),y=this.convertFactionIdToFactionData(t.fac),g=!1,v="",k=!1,b=!1;""!=t.id&&(k=!0,"undefined"==typeof players.currentList[t.id]&&players.add(t.id,v,c,y,e),v=r?'<span class="operation-driver unit-marker__label--'+t.id+'">'+players.getNameFromId(t.id)+"</span>":players.getNameFromId(t.id));var w=k?t.id:this.cleanUnitName(e);r&&d.length&&d.length>1&&(v+=this.addCrewCargoToLabel("crew",d,t.id)),r&&m.length&&m.length>1&&(v+=this.addCrewCargoToLabel("cargo",m,t.id)),o&&k&&map.currentZoomLevel<this.maxZoomLevelForIndividualPlayerLabels&&(v=h?c.toUpperCase():" ");var T={iconSize:[30,30],iconAnchor:[15,15],className:"unit-marker unit-marker__class--"+l+" unit-marker--"+s+" unit-marker__id--"+w,iconUrl:webRoot+"/r3/assets/images/map/markers/"};if("undefined"==typeof this.list[e]){g=!0;var C=T.iconUrl+n.getIconWithFaction(r,p,s,y),P=L.icon(_.extend(T,{iconUrl:C}));this.list[e]=L.marker(map.rc.unproject([f[0],f[1]]),{icon:P,clickable:!1,rotationAngle:u,rotationOrigin:"50% 50%"}).bindLabel(v,{noHide:!0,className:"unit-marker__label unit-marker__label--"+i+" unit-marker__label--"+t.id}),this.eventGroups[i].addLayer(this.list[e]),this.list[e].showLabel(),k&&!playBack.zoomedToFirstPlayer&&o&&(map.handler.setView(map.rc.unproject([f[0],f[1]]),4),playBack.zoomedToFirstPlayer=!0)}else{if(this.list[e].setLatLng(map.rc.unproject([f[0],f[1]])),u!=this.list[e].angle){var x=this.calcShortestRotationAdjustment(this.list[e].angle,u);this.list[e].angle=x,this.list[e].setRotationAngle(x)}if("undefined"!=typeof this.list[e].unconscious&&this.list[e].unconscious){var C=T.iconUrl+"iconMan-unconcious.png",P=L.icon(_.extend(T,{iconUrl:C,className:T.className+" unit-marker__label--unconscious"}));this.list[e].setIcon(P)}else if(this.list[e].posType!=i&&!b||"undefined"!=typeof this.list[e].killed){"undefined"!=typeof this.list[e].killed&&(delete this.list[e].killed,this.list[e].setOpacity(1));var C=T.iconUrl+n.getIconWithFaction(r,p,s,y),P=L.icon(_.extend(T,{iconUrl:C}));this.list[e].setIcon(P)}else var C=this.list[e].iconUrl;this.list[e].posType!=i&&("positions_vehicles"==i&&$(".unit-marker__label--"+t.id).removeClass("unit-marker__label--positions_infantry").addClass("unit-marker__label--positions_vehicles"),"positions_infantry"==i&&$(".unit-marker__label--"+t.id).removeClass("unit-marker__label--positions_vehicles").addClass("unit-marker__label--positions_infantry"),this.list[e].posType=i),this.list[e].originalLabel=v,this.list[e].label.setContent(v),f[2]>10&&this.list[e].label.setContent(this.list[e].originalLabel+'<span class="player-marker-stat">'+String(Math.round(f[2]))+"m</span>")}if(this.list[e].timeUpdated=a,this.list[e].posType=i,this.list[e].angle=u,this.list[e].originalLabel=v,this.list[e].faction=y.name,this.list[e].iconUrl=C,this.list[e].crew=d,this.list[e].cargo=m,k&&g&&players.updateList(),players.trackTarget&&(players.trackTarget==t.id||r&&(~d.indexOf(players.trackTarget)||~m.indexOf(players.trackTarget)))){this.list[e].setZIndexOffset(9999),$(".unit-marker--tracking").removeClass("unit-marker--tracking"),$(".unit-marker__label--tracking").removeClass("unit-marker__label--tracking"),r&&!$(".unit-marker__label--"+players.trackTarget).length?$(".unit-marker__label__group--"+c).not(".unit-marker__label--positions_vehicles").addClass("unit-marker__label--tracking").css("z-index",99999):$(".unit-marker__label--"+players.trackTarget).not(".unit-marker__label--positions_vehicles").addClass("unit-marker__label--tracking").css("z-index",99999)," "==v&&this.list[e].label.setContent(players.getNameFromId(t.id));var M=map.handler.latLngToLayerPoint(this.list[e].getLatLng()),I=M.distanceTo(map.handler.latLngToLayerPoint(map.handler.getCenter()));I>200&&map.handler.panTo(map.rc.unproject([f[0],f[1]]))}}},Markers.prototype.findPlayerInCrew=function(e){return _.find(markers.list,function(t){return"undefined"!=typeof t.crew&&t.crew.length?t.crew.indexOf(e):!("undefined"==typeof t.cargo||!t.cargo.length)&&t.cargo.indexOf(e)})},Markers.prototype.getIconWithFaction=function(e,t,i,a){var n=i+".png";return"undefined"!=typeof t&&"undefined"!=typeof this.icons[t.toLowerCase()]&&(n=this.icons[t.toLowerCase()]+".png"),n.replace(".png","-"+a.name+".png")},Markers.prototype.addCrewCargoToLabel=function(e,t,i){var a='<span class="operation-'+e+'">',n={};return _.each(t,function(s){if(s!=i){var o=players.getInfo(s);"undefined"!=typeof o&&("cargo"==e&&t.length>5?"undefined"==typeof n[o.group]?(n[o.group]=1,a+='<span class="operation-cargo__unit unit-marker__label__group--'+o.group+'">'+o.group+"</span>"):n[o.group]++:a+='<span class="operation-cargo__unit unit-marker__label--'+s+'">'+o.name+"</span>")}}),a+="</span>"},Markers.prototype.convertFactionIdToFactionData=function(e){var t={name:"unknown",color:"#CCCCCC"};switch(e=parseInt(e)){case 0:t.name="east",t.color="#ED5C66";break;case 1:t.name="west",t.color="#2848E9";break;case 2:t.name="independant",t.color="#518245";break;case 3:t.name="civilian",t.color="#7D26CD"}return t},Markers.prototype.cleanUnitName=function(e){return e},Markers.prototype.getRotation=function(e){var t=window.getComputedStyle(e,null),i=t.getPropertyValue("-webkit-transform")||t.getPropertyValue("-moz-transform")||t.getPropertyValue("-ms-transform")||t.getPropertyValue("-o-transform")||t.getPropertyValue("transform")||"fail...";if("none"!==i){var a=i.split("(")[1];a=a.split(")")[0],a=a.split(",");var n=a[0],s=a[1],o=(a[2],a[3],Math.sqrt(n*n+s*s),Math.atan2(s,n)),r=Math.round(o*(180/Math.PI))}else var r=0;return r},Markers.prototype.calcShortestRotationAdjustment=function(e,t){var e,i;return e=e||0,i=e%360,i<0&&(i+=360),i<180&&t>i+180&&(e-=360),i>=180&&t<=i-180&&(e+=360),e+=t-i},Modal.prototype.setupInteractionHandlers=function(){var e=this;$("body").on("click",".modal__close",function(t){t.preventDefault(),e.hide()})},Modal.prototype.hide=function(e){$(".modal").removeClass("modal--show")},Modal.prototype.show=function(e,t){$("#"+e).addClass("modal--show")},Notifications.prototype.init=function(){toastr.options={closeButton:!1,debug:!1,newestOnTop:!1,progressBar:!1,positionClass:"toast-top-right",preventDuplicates:!0,onclick:null,showDuration:"300",hideDuration:"1000",timeOut:"5000",extendedTimeOut:"1000",showEasing:"swing",hideEasing:"linear",showMethod:"fadeIn",hideMethod:"fadeOut",target:".playback-container"},this.setupInteractionHandlers()},Notifications.prototype.setupInteractionHandlers=function(){$(window).resize(this.checkWindowWidth)},Notifications.prototype.checkWindowWidth=function(){this.enabled=$(window).width()>=this.minWidth},Notifications.prototype.info=function(e){this.enabled&&toastr.info(e)},Notifications.prototype.warning=function(e){this.enabled&&toastr.warning(e)},Notifications.prototype.error=function(e){this.enabled&&toastr.error(e)},ObjectiveMarkers.prototype.init=function(e){this.setupInteractionHandlers()},ObjectiveMarkers.prototype.setupInteractionHandlers=function(){var e=this;$("body").on("click",".hide-markers__ignore",function(e){e.preventDefault(),$(".hide-markers").fadeOut(),$(".hide-markers__ignore").fadeOut()}),$("body").on("click",".hide-markers",function(t){t.preventDefault(),$(this).hasClass("hide-markers--active")?($(this).removeClass("hide-markers--active").find("span").html("Hide editor markers"),e.layer.addTo(map.handler)):($(this).addClass("hide-markers--active").find("span").html("Show editor markers"),map.handler.removeLayer(e.layer))})},ObjectiveMarkers.prototype.add=function(e){var t=this,i=!1;this.layer||(this.layer=new L.featureGroup([]),this.layer.addTo(map.handler)),async.forEachOf(e,function(e,a,n){var s=e.type.toLowerCase();if(t.supportedList.indexOf(s)===-1)return console.warn("Unsupported marker",e),n();0==t.validMarkerCount&&(i=!0);var o=[0,0],r=[30,30],l=[15,15],p=L.icon({iconUrl:"https://r3icons.titanmods.xyz/"+s+".png",iconSize:r,iconAnchor:l,className:"obj-marker-image obj-marker-image--"+s}),c=map.gamePointToMapPoint(e.pos[0],e.pos[1]),d=L.marker(map.rc.unproject([c[0],c[1]]),{icon:p,clickable:!1}).bindLabel(e.text,{noHide:!0,className:"obj-marker obj-marker-"+s,offset:o});t.layer.addLayer(d),n()},function(e){i&&$(".hide-markers, .hide-markers__ignore").show()})},PlayBack.prototype.init=function(e,t,i){var a=this;this.replayDetails=e,this.sharedPresets=t,"undefined"!=typeof this.sharedPresets.centerLat&&(this.zoomedToFirstPlayer=!0),map.init(this.replayDetails.map,function(e){return e?void alert("Missing terrain: "+this.replayDetails.map):(players.init(),void a.fetch(i))})},PlayBack.prototype.fetch=function(e){var t=webRoot+"/api/aar",i="GET",a=this;e||$(".timeline").addClass("timeline--caching"),$.ajax({url:t,type:i,dataType:"json",data:{name:opName,map:opMap,clan:opClan},success:this.prepData.bind(a),error:function(e,t,i){console.log("Error fetching playback data - Status: "+t+" - Message: "+i);e.status>=200&&e.status<400?i:e.status;alert("Error fetching playback data - Status: "+t+" - Message: "+i)}})},PlayBack.prototype.prepData=function(e){if("undefined"!=typeof e.id)return this.fetch(!0);$("#timeline__silder .progress").remove(),markers.setupLayers(),_.each(e,function(e){"undefined"==typeof events.list[e.missionTime]&&(events.list[e.missionTime]=[]),events.list[e.missionTime].push(e)}),timeline.setupScrubber(e),timeline.changeSpeed(timeline.speed),this.sharedPresets.centerLat?(console.log("This is a shared playback",this.sharedPresets),map.handler.setView([this.sharedPresets.centerLat,this.sharedPresets.centerLng],this.sharedPresets.zoom),timeline.skipTime(parseInt(this.sharedPresets.time))):timeline.startTimer(),players.startInactiveListTimer(5)},Players.prototype.init=function(){var e=webRoot+"/api/playersbyoperation",t="GET",i=this;$.ajax({url:e,type:t,dataType:"json",data:{name:opName,map:opMap,clan:opClan},success:this.prepData.bind(i),error:function(e,t,i){console.log("Error fetching player data - Status: "+t+" - Message: "+i)}}),this.setupInteractionHandlers(),$(".player-list__content").perfectScrollbar({suppressScrollX:!0}),$(".player-list__content .ps-scrollbar-y-rail").unbind("click"),$(".player-list__content .ps-scrollbar-y").unbind("mousedown"),"undefined"!=typeof playBack.sharedPresets.track&&(this.trackTarget=playBack.sharedPresets.track)},Players.prototype.setupInteractionHandlers=function(){var e=this;$(".player-list").on("mouseenter",function(){clearTimeout(e.listInactiveTimer),$(this).removeClass("player-list--inactive")}),$(".player-list").on("mouseleave",function(){clearTimeout(e.listInactiveTimer),e.startInactiveListTimer()}),$("body").on("click",".player-list__group__member",function(t){t.preventDefault(),$(".player-list__group__member--tracking").removeClass("player-list__group__member--tracking"),$(this).addClass("player-list__group__member--tracking"),e.trackTarget=$(this).attr("data-id")}),$("body").on("click",".expand-handle",function(t){t.preventDefault(),$(this).next(".expand-list").slideToggle(200),$(this).toggleClass("expand");var i=$(this).parent().attr("data-group");$(this).hasClass("expand")?delete e.collapseList[i]:e.collapseList[i]=!0}),$("body").on("click",".player-list__toggle-sticky",function(t){t.preventDefault(),$(this).hasClass("player-list__toggle-sticky--inactive")?($(this).removeClass("player-list__toggle-sticky--inactive"),e.listFadeEnabled=!0):($(this).addClass("player-list__toggle-sticky--inactive"),clearTimeout(e.listInactiveTimer),e.listFadeEnabled=!1)})},Players.prototype.startInactiveListTimer=function(e){e=e||this.listFadeTime;var t=this;this.listInactiveTimer=setTimeout(function(){t.listFadeEnabled&&$(".player-list").addClass("player-list--inactive")},1e3*e)},Players.prototype.prepData=function(e){console.log("Prepping master list");var t=this;_.each(e,function(e){t.masterList[e.id]=e}),this.updateList()},Players.prototype.add=function(e,t,i,a,n){console.log("Adding player",t),this.currentList[e]={name:t},"undefined"!=typeof this.masterList[e]&&(this.masterList[e].unit=n,this.masterList[e].group=i),"undefined"==typeof this.factionGroups[a.name]&&(this.factionGroups[a.name]={meta:a,groups:{}}),"undefined"==typeof this.factionGroups[a.name].groups[i]&&(this.factionGroups[a.name].groups[i]={members:[]}),this.factionGroups[a.name].groups[i].members.push(e),this.updateList()},Players.prototype.getInfo=function(e){return _.find(this.masterList,function(t){return t.id==e})},Players.prototype.getNameFromId=function(e){var t=this.getInfo(e);return"undefined"==typeof t?"Unknown":t.name},Players.prototype.updateList=function(e){if(e=e||!1,this.updateLock&&!e)return clearTimeout(this.delayedUpdateTimer),void(this.delayedUpdateTimer=setTimeout(function(){players.updateList()},500));this.updateLock=!0;var t=this;if(!_.size(this.factionGroups))return void(t.updateLock=!1);clearTimeout(this.delayedUpdateTimer);var i=$(".player-list"),a=$(".player-list__content");a.html(""),_.each(this.factionGroups,function(e,i){var n="undefined"==typeof t.collapseList[i]?"expand":"collapse";a.append('<div class="player-list__faction" data-group="'+i+'"><a href="#" class="expand-handle '+n+'">'+i+'</a> <div class="expand-list"></div></div>');var s=t.sortGroups(e.groups);_.each(s,function(e,a){var n="undefined"==typeof t.collapseList[a]?"expand":"collapse";$('.player-list__faction[data-group="'+i+'"]').find(".expand-list").eq(0).append('<div class="player-list__group" data-group="'+a+'"><a href="#" class="expand-handle '+n+'">'+a+'</a> <div class="expand-list"></div></div>'),_.each(e.members,function(e){var n=t.getInfo(e),s="https://r3icons.titanmods.xyz/blank.png";if("undefined"!=typeof markers.list[n.unit])s=markers.list[n.unit].iconUrl;else{var o=markers.findPlayerInCrew(n.playerId);o&&(s=o.iconUrl)}s=s.replace(".png","-trim.png");var r=t.trackTarget==e?"player-list__group__member--tracking":"";$('.player-list__faction[data-group="'+i+'"] .player-list__group[data-group="'+a+'"]').find(".expand-list").eq(0).append('                    <a href="#" class="player-list__group__member '+r+'" data-id="'+e+'">                        <img src="'+s+'">                        '+n.name+"                    </a>")})})}),i.show(),$(".player-list__content").perfectScrollbar("update"),setTimeout(function(){t.updateLock=!1},1e3)},Players.prototype.stopTracking=function(){if(this.trackTarget){this.trackTarget=!1;var e=$(".player-list .player-list__group__member--tracking");e.removeClass("player-list__group__member--tracking"),$(".unit-marker__label--tracking").removeClass("unit-marker__label--tracking"),e.addClass("player-list__group__member--stop-tracking"),$(".player-list").removeClass("player-list--inactive"),this.startInactiveListTimer(),setTimeout(function(){e.removeClass("player-list__group__member--stop-tracking")},3e3)}},Players.prototype.sortGroups=function(e){var t=_.sortBy(_.keys(e),function(e){return e}),i={};return _.each(t,function(t){i[t]=e[t]}),i},Poi.prototype.init=function(e){this.terrain=e,this.setupInteractionHandlers(),this.add()},Poi.prototype.setupInteractionHandlers=function(){var e=this;map.handler.on("zoomend",function(t){e.filterZoomLayers()})},Poi.prototype.add=function(){var e=this;$.getJSON(map.tileDomain+this.terrain+"/poi.json",function(t){async.forEachOf(t,function(t,i,a){var n;if("mount"!=t.type){"undefined"==typeof e.poiLayers[t.type]?("mount"!=t.type?(n=new L.featureGroup([]),n.addTo(map.handler)):n=new L.LayerGroup([],{makeBoundsAware:!0}),e.poiLayers[t.type]=n):n=e.poiLayers[t.type];var s="blank",o=[0,0],r=[30,30],l=[15,15];switch(t.type){case"hill":s="hill_ca",o=[10,0],r=[15,15],l=[7,7];break;case"rockarea":s="rockarea_ca",o=[10,0],r=[15,15],l=[7,7]}var p=L.icon({iconUrl:"https://r3icons.titanmods.xyz/"+s+".png",iconSize:r,iconAnchor:l,className:"poi-image--"+t.type}),c=map.gamePointToMapPoint(t.x,t.y),d=L.marker(map.rc.unproject([c[0],c[1]]),{icon:p,clickable:!1}).bindLabel(t.label,{noHide:!0,className:"poi poi-"+t.type,offset:o});n.addLayer(d),a()}},function(t){e.ready=!0,e.filterZoomLayers()})}).fail(function(e){console.log("Error loading terrain POI, does the JSON file exist and is it valid JSON?",e)})},Poi.prototype.filterZoomLayers=function(){if(this.ready){var e=this,t=map.handler.getZoom();_.each(this.poiLayers,function(i,a){t<4&&"namecitycapital"!=a&&"namecity"!=a&&"mount"!=a&&map.handler.removeLayer(e.poiLayers[a]),t>3&&"mount"!=a&&e.poiLayers[a].addTo(map.handler),t>5&&"mount"==a&&e.poiLayers[a].addTo(map.handler),t<6&&"mount"==a&&map.handler.removeLayer(e.poiLayers[a])})}},ReplayList.prototype.init=function(e){this.lists[e]||(this.lists[e]=new List(e,{valueNames:[e+"-mission-list__item__name",e+"-mission-list__item__map",e+"-mission-list__item__length",e+"-mission-list__item__player-count",e+"-mission-list__item__date"],searchClass:e+"-mission-list__search",sortClass:e+"-mission-list__sort",listClass:e+"-list",plugins:[ListFuzzySearch()]}))},ReplayList.prototype.setupInteractionHandlers=function(){var e=this;$("body").on("click",".mission-list__sort",function(e){$(this).hasClass("mission-list__sort--asc")?$(this).removeClass("mission-list__sort--asc").addClass("mission-list__sort--desc"):$(this).removeClass("mission-list__sort--desc").addClass("mission-list__sort--asc")}),$("body").on("focus",".text-input--with-icon .text-input",function(e){$(this).parent().removeClass("text-input--with-icon--unfocused")}),$("body").on("blur",".text-input--with-icon .text-input",function(e){$(this).parent().addClass("text-input--with-icon--unfocused")}),$("body").on("click",".mission-list__tab",function(t){t.preventDefault();var i=$(".mission-list__tab--active").attr("data-list"),a=$(this).attr("data-list");if($(".mission-list__tab--active").removeClass("mission-list__tab--active"),$(".mission-list--active").removeClass("mission-list--active"),$(this).addClass("mission-list__tab--active"),$("#"+a).addClass("mission-list--active"),!$("#"+a+' input[name="my-player-id"]').length){e.init(a);var n=$("."+i+"-mission-list__search").val();$("."+a+"-mission-list__search").val(n),e.lists[a].search(n)}}),$("body").on("click",".new-user__save",function(t){t.preventDefault(),$.ajax({url:webPath+"/save-player-id",type:"POST",dataType:"json",data:{id:$('input[name="my-player-id"]').val()},success:function(t){t.error?alert(t.error):($("#missions-mine").html(t.myReplaysHtml),e.init("missions-mine"))},error:function(e){console.log("Error saving player ID",e)}})})},window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(e){window.setTimeout(e,100)}}(),Timeline.prototype.setupScrubber=function(e){this.timeBounds.min=parseInt(e[0].missionTime),this.timeBounds.max=parseInt(e[e.length-1].missionTime),"undefined"!=typeof playBack.sharedPresets.speed&&(this.speed=playBack.sharedPresets.speed),this.scrubber=document.getElementById("timeline__silder"),$(".timeline__silder__value").html(0),$(".timeline").removeClass("timeline--loading"),$(".timeline").removeClass("timeline--caching"),this.timePointer=this.timeBounds.min,noUiSlider.create(this.scrubber,{start:this.timeBounds.min,animate:!1,connect:"lower",step:1,range:{min:this.timeBounds.min,max:this.timeBounds.max}}),this.setupInteractionHandlers()},Timeline.prototype.setupInteractionHandlers=function(){var e=this;this.scrubber.noUiSlider.on("slide",function(t){console.log("Sliding",Math.round(t[0])),e.skipTime(t[0])}),$("body").on("click",".timeline__toggle-playback",function(t){t.preventDefault(),e.playing?($(".timeline__toggle-playback .fa").removeClass("fa-pause").addClass("fa-play"),e.stopTimer()):($(".timeline__toggle-playback .fa").removeClass("fa-play").addClass("fa-pause"),e.startTimer())}),$("body").on("click",".timeline__speed",function(t){t.preventDefault(),e.changeSpeed($(this).data("speed"))}),$("body").on("click",".timeline__share",function(t){t.preventDefault(),e.stopTimer();var i=webPath+"/"+playBack.replayDetails.id+"/"+playBack.replayDetails.slug+"?share",a=map.handler.getCenter();i+="&centerLat="+a.lat,i+="&centerLng="+a.lng,i+="&zoom="+map.handler.getZoom(),i+="&time="+e.timePointer,i+="&speed="+e.speed,players.trackTarget&&(i+="&track="+players.trackTarget),console.log(i),$.ajax({url:webPath+"/fetch-share-url",type:"POST",dataType:"json",data:{url:i},success:function(e){$("#modal__share .share__copy-link").val(e),modal.show("modal__share");var t=new Clipboard(".share__copy-link",{text:function(){return e}});t.on("success",function(e){$(".share__copy-link").select(),$(".share__copy-link__container").addClass("share__copy-link__container--copied"),setTimeout(function(){$(".share__copy-link__container").removeClass("share__copy-link__container--copied"),t.destroy()},2e3)}),"undefined"!=typeof window.history.pushState&&window.history.pushState({},null,e)},error:function(e,t,i){console.log("Error fetching share URL - Status: "+t+" - Message: "+i)}})}),$("body").on("click",".timeline__fullscreen",function(e){e.preventDefault(),screenfull.enabled&&screenfull.toggle()})},Timeline.prototype.changeSpeed=function(e){$(".timeline__speed--active").removeClass("timeline__speed--active"),$('.timeline__speed[data-speed="'+e+'"]').addClass("timeline__speed--active"),this.speed=e,60==this.speed?this.timeJump=5:this.timeJump=1},Timeline.prototype.skipTime=function(e){this.timePointer=Math.round(e),console.log("Skipping time",this.timePointer),markers.eventGroups.positions_vehicles.clearLayers(),markers.eventGroups.positions_infantry.clearLayers(),markers.currentList={},markers.list={},markers.currentUnits.positions_vehicles=[],markers.currentUnits.positions_infantry=[],this.playing||this.startTimer(),setTimeout(function(){players.updateList(!0)},1e3)},Timeline.prototype.startTimer=function(){var e=this;this.stopTimer(),this.playing=!0,$(".timeline__toggle-playback .fa").removeClass("fa-play").addClass("fa-pause"),playBack.sharedPresets.trackPlayer&&(playBack.trackTarget=playBack.sharedPresets.trackPlayer),function t(){if(e.playing){requestAnimFrame(t),e.now=Date.now(),e.delta=e.now-e.then;var i=1e3/e.speed;
if(e.delta>i&&!map.zooming){e.scrubber.noUiSlider.set(e.timePointer);var a=new Date(null);a.setSeconds(e.timePointer),$(".noUi-handle").html(a.toISOString().substr(11,8)),parseInt($(".noUi-origin").css("left"))>70?$(".noUi-handle").addClass("left-time"):$(".noUi-handle").removeClass("left-time"),e.timePointer>=e.timeBounds.max?e.stopTimer():events.showNext(),e.then=e.now-e.delta%i}}}()},Timeline.prototype.stopTimer=function(){this.playing=!1,console.warn("Timer stopped"),$(".timeline__toggle-playback .fa").removeClass("fa-pause").addClass("fa-play")};var replayList=new ReplayList,playBack=new PlayBack,events=new Events,players=new Players,markers=new Markers,poi=new Poi,objectiveMarkers=new ObjectiveMarkers,map=new Map,timeline=new Timeline,notifications=new Notifications,modal=new Modal,admin=new Admin;$("document").ready(function(){modal.setupInteractionHandlers(),$(".mission-list__tab").length&&(replayList.init("missions-all"),replayList.setupInteractionHandlers()),"undefined"!=typeof replayDetails&&(playBack.init(replayDetails,sharedPresets,cacheAvailable),notifications.init()),$("body").on("click",".js-help",function(e){e.preventDefault(),modal.show("modal__help")})});